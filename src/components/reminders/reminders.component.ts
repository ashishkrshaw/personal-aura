import { ChangeDetectionStrategy, Component, signal, OnDestroy, OnInit, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { DataService } from '../../services/data.service';

interface Reminder {
  id: number;
  text: string;
  due: string; // ISO string
  notified: boolean;
}

@Component({
  selector: 'app-reminders',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './reminders.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class RemindersComponent implements OnInit, OnDestroy {
  private dataService = inject(DataService);

  reminders = signal<Reminder[]>([]);
  newReminderText = signal('');
  newReminderDate = signal(this.getInitialDateTime());

  activeNotification = signal<Reminder | null>(null);
  notificationPermission = signal<NotificationPermission>('default');
  private checkInterval: any;

  constructor() {
    this.dataService.getReminders().subscribe(reminders => {
      this.reminders.set(reminders);
    });
  }

  ngOnInit() {
    if ('Notification' in window) {
      this.notificationPermission.set(Notification.permission);
    }
    // The arrow function here correctly preserves the `this` context,
    // preventing the "this.checkReminders is not a function" error.
    this.checkInterval = setInterval(() => this.checkReminders(), 5000);
  }

  ngOnDestroy() {
    clearInterval(this.checkInterval);
  }

  requestNotificationPermission() {
    if ('Notification' in window) {
      Notification.requestPermission().then(permission => {
        this.notificationPermission.set(permission);
      });
    }
  }

  private getInitialDateTime(): string {
    const now = new Date();
    now.setHours(now.getHours() + 1); // Default to one hour from now
    now.setMinutes(0);
    // Format to YYYY-MM-DDTHH:MM which is required by datetime-local input
    const timezoneOffset = now.getTimezoneOffset() * 60000;
    const localISOTime = new Date(now.getTime() - timezoneOffset).toISOString().slice(0, 16);
    return localISOTime;
  }

  addReminder() {
    if (!this.newReminderText().trim() || !this.newReminderDate()) return;

    const newReminder: Reminder = {
      id: Date.now(),
      text: this.newReminderText(),
      due: new Date(this.newReminderDate()).toISOString(),
      notified: false
    };

    this.reminders.update(reminders => [...reminders, newReminder]
      .sort((a, b) => new Date(a.due).getTime() - new Date(b.due).getTime()));
    this.saveReminders();

    this.newReminderText.set('');
    this.newReminderDate.set(this.getInitialDateTime());
  }

  deleteReminder(id: number) {
    this.reminders.update(r => r.filter(reminder => reminder.id !== id));
    this.saveReminders();
    if(this.activeNotification()?.id === id) {
        this.activeNotification.set(null);
    }
  }

  checkReminders() {
    const now = new Date().getTime();
    let hasChanges = false;
    this.reminders.update(reminders => {
      const toNotify = reminders.find(r => !r.notified && new Date(r.due).getTime() <= now);
      if (toNotify) {
        this.triggerNotification(toNotify);
        hasChanges = true;
        return reminders.map(r => r.id === toNotify.id ? { ...r, notified: true } : r);
      }
      return reminders;
    });

    if (hasChanges) {
      this.saveReminders();
    }
  }

  private triggerNotification(reminder: Reminder) {
    // Show native notification if permission is granted
    if (this.notificationPermission() === 'granted') {
        new Notification('AURA Reminder', {
            body: reminder.text,
            icon: 'data:image/svg+xml,%3Csvg width=\'48\' height=\'48\' viewBox=\'0 0 48 48\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cdefs%3E%3CradialGradient id=\'grad\' cx=\'50%25\' cy=\'50%25\' r=\'50%25\' fx=\'30%25\' fy=\'30%25\'%3E%3Cstop offset=\'0%25\' stop-color=\'%23E9D5FF\'/%3E%3Cstop offset=\'100%25\' stop-color=\'%23A855F7\'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx=\'24\' cy=\'24\' r=\'20\' fill=\'url(%23grad)\'/%3E%3C/svg%3E',
        });
    }

    // Also show in-app notification
    this.activeNotification.set(reminder);
    this.playNotificationSound();
  }
  
  dismissNotification() {
      this.activeNotification.set(null);
  }

  private playNotificationSound() {
    const sound = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTSEUAAAABA1RXQVAAAAABA1RFTkMAAAAD73gAAAATEAAAZGF3bnNpbmsuY29tAAAAAExhdmY2MC4zLjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAFAAAEAgAAAB1odHRwczovL2Rhd25zaW5rLmNvbS9kb3dubG9hZC81NjgvMAAA//tQwISEAszLIIAAOBAAP/y0RgBAMA4AD/8lIAAODgAA/yPAAD/8bQAA///sAAAD/NEAAwEAAAP+xAAD/7IAAA//BAAP/mQAAB/yAAAP/wQAD/5kAAP/lAAA//BAAP/uQAA//BAAD/7EAA//BAAP/rQAA//BAAP/oQAAAA//tQwMSYAzNEogAPANQ/65CAADg4AAA8DQAAHYAAD/sDAAAGwAAAEsAAAP/5wAABsAAAf/vAAABiwAAD/8EAAAGKAA//BAAABhQAP/kQAAAYEAA//BAAABdAA//BAAAG0AA//BAAAGkAA//BAAABmgAP/oQAAAAAAAAAAAAAA//tQwMSYgzNMsgAA8A1D/rkIAAODgAADwNAAAxwAA//AwAABsAAABPAAAD/+cAAAbAAAH/7wAAAcoAAD/8EAAAGKAA//BAAABhQAP/kQAAAYEAA//BAAABdAA//BAAAG0AA//BAAAGkAA//BAAABmgAP/oQAAAA//tQwMSYAzNUsgAAPANQ/65CAADg4AAA8DQAAOEAAP/wMAAAbAAAAUQAAP/5wAABsAAAf/vAAAEBwAAD/8EAAAGKAA//BAAABhQAP/kQAAAYEAA//BAAABdAA//BAAAG0AA//BAAAGkAA//BAAABmgAP/oQAAAA//tQwMSYgzNVsggA8A1D/rkIAAODgAADwNAAA4wAA//AwAABsAAAAVgAA//nAAAGwAAB/+8AAAHPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzNksggA8A1D/rkIAAODgAADwNAAA8wAA//AwAABsAAAAbAAA//nAAAGwAAB/+8AAADPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzNusggA8A1D/rkIAAODgAADwNAAA+QAA//AwAABsAAAAgQAA//nAAAGwAAB/+8AAAETAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzOssgAA8A1D/rkIAAODgAADwNAAAPwAA//AwAABsAAAAdAAA//nAAAGwAAB/+8AAAEeAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzPUsgAA8A1D/rkIAAODgAADwNAAA/AAA//AwAABsAAAAigAA//nAAAGwAAB/+8AAAFXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzPdsggA8A1D/rkIAAODgAADwNAAA/wAA//AwAABsAAAAkgAA//nAAAGwAAB/+8AAAGDAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzQEsggA8A1D/rkIAAODgAADwNAAA/wAA//AwAABsAAAAmAAA//nAAAGwAAB/+8AAAGmAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzQksggA8A1D/rkIAAODgAADwNAAA/QAA//AwAABsAAAAqgAA//nAAAGwAAB/+8AAAHPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzRssggA8A1D/rkIAAODgAADwNAAA+gAA//AwAABsAAAAtgAA//nAAAGwAAB/+8AAAI/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzR0sgAA8A1D/rkIAAODgAADwNAAA+QAA//AwAABsAAAAygAA//nAAAGwAAB/+8AAAJnAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzSUsggA8A1D/rkIAAODgAADwNAAA9wAA//AwAABsAAAA0gAA//nAAAGwAAB/+8AAAK/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzSksggA8A1D/rkIAAODgAADwNAAA9AAA//AwAABsAAAA3gAA//nAAAGwAAB/+8AAAL3AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzTMsgAA8A1D/rkIAAODgAADwNAAA8gAA//AwAABsAAAA5gAA//nAAAGwAAB/+8AAAMXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzTcsgAA8A1D/rkIAAODgAADwNAAA7wAA//AwAABsAAAA7gAA//nAAAGwAAB/+8AAANXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzUMsgAA8A1D/rkIAAODgAADwNAAA7AAA//AwAABsAAAA+AAA//nAAAGwAAB/+8AAAN3AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzUcsggA8A1D/rkIAAODgAADwNAAA6AAA//AwAABsAAAA/wAA//nAAAGwAAB/+8AAAO/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzVUsgAA8A1D/rkIAAODgAADwNAAA5AAA//AwAABsAAABAwAA//nAAAGwAAB/+8AAAPfAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzVksggA8A1D/rkIAAODgAADwNAAA4AAA//AwAABsAAABFgAA//nAAAGwAAB/+8AAAQXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzWIsgAA8A1D/rkIAAODgAADwNAAA2wAA//AwAABsAAABIgAA//nAAAGwAAB/+8AAAQ3AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzWgsggA8A1D/rkIAAODgAADwNAAA1gAA//AwAABsAAABMAAA//nAAAGwAAB/+8AAARXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzXAsgAA8A1D/rkIAAODgAADwNAAA0QAA//AwAABsAAABUAAA//nAAAGwAAB/+8AAAR3AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzXUoggA8A1D/rkIAAODgAADwNAAAywAA//AwAABsAAABagAA//nAAAGwAAB/+8AAASPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzYAsggA8A1D/rkIAAODgAADwNAAAwgAA//AwAABsAAABigAA//nAAAGwAAB/+8AAATXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzYUsggA8A1D/rkIAAODgAADwNAAAvQAA//AwAABsAAABqgAA//nAAAGwAAB/+8AAAU3AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzZEsggA8A1D/rkIAAODgAADwNAAAtgAA//AwAABsAAABtAAA//nAAAGwAAB/+8AAAVnAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzZEsggA8A1D/rkIAAODgAADwNAAAtgAA//AwAABsAAABtAAA//nAAAGwAAB/+8AAAVnAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzY8oggA8A1D/rkIAAODgAADwNAAAvAAA//AwAABsAAABoAAA//nAAAGwAAB/+8AAAUfAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzX7sgAA8A1D/rkIAAODgAADwNAAAywAA//AwAABsAAABdAAA//nAAAGwAAB/+8AAASPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzXmsggA8A1D/rkIAAODgAADwNAAA0gAA//AwAABsAAABTgAA//nAAAGwAAB/+8AAAR/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzW5sggA8A1D/rkIAAODgAADwNAAA1QAA//AwAABsAAABJgAA//nAAAGwAAB/+8AAARHAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzWDsggA8A1D/rkIAAODgAADwNAAA2gAA//AwAABsAAABDAAA//nAAAGwAAB/+8AAAQvAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzU/sggA8A1D/rkIAAODgAADwNAAA3wAA//AwAABsAAAA8gAA//nAAAGwAAB/+8AAAP/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzU1sggA8A1D/rkIAAODgAADwNAAA5AAA//AwAABsAAABAwAA//nAAAGwAAB/+8AAAPfAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzT4MggA8A1D/rkIAAODgAADwNAAA6wAA//AwAABsAAAA9gAA//nAAAGwAAB/+8AAAOHAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzTnMggA8A1D/rkIAAODgAADwNAAA7gAA//AwAABsAAAA7QAA//nAAAGwAAB/+8AAANXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzS8MggA8A1D/rkIAAODgAADwNAAA8gAA//AwAABsAAAA6AAA//nAAAGwAAB/+8AAAMXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzSgMggA8A1D/rkIAAODgAADwNAAA9AAA//AwAABsAAAA3QAA//nAAAGwAAB/+8AAAL/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzR7MggA8A1D/rkIAAODgAADwNAAA9wAA//AwAABsAAAAzAAA//nAAAGwAAB/+8AAAK/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzRcMggA8A1D/rkIAAODgAADwNAAA+QAA//AwAABsAAAAsgAA//nAAAGwAAB/+8AAAJnAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzQwMggA8A1D/rkIAAODgAADwNAAA+gAA//AwAABsAAAAqAAA//nAAAGwAAB/+8AAAI/AAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzP5MggA8A1D/rkIAAODgAADwNAAA/QAA//AwAABsAAAAkwAA//nAAAGwAAB/+8AAAHPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzPmMggA8A1D/rkIAAODgAADwNAAA/wAA//AwAABsAAAAiQAA//nAAAGwAAB/+8AAAGDAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzPEcggA8A1D/rkIAAODgAADwNAAA/wAA//AwAABsAAAAfQAA//nAAAGwAAB/+8AAAFXAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzO2MggA8A1D/rkIAAODgAADwNAAA/AAA//AwAABsAAAAcgAA//nAAAGwAAB/+8AAAEeAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzOicggA8A1D/rkIAAODgAADwNAAAPwAA//AwAABsAAAAbgAA//nAAAGwAAB/+8AAAETAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzN5sggA8A1D/rkIAAODgAADwNAAA+QAA//AwAABsAAAAZAAA//nAAAGwAAB/+8AAADPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzNmcggA8A1D/rkIAAODgAADwNAAA8wAA//AwAABsAAAAVwAA//nAAAGwAAB/+8AAAHPAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzM8cggA8A1D/rkIAAODgAADwNAAA4wAA//AwAABsAAAASAAA//nAAAGwAAB/+8AAAEBwAAD/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzMscggA8A1D/rkIAAODgAADwNAAA4QAA//AwAABsAAAAPgAA//nAAAGwAAB/+8AAAHIAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYgzL4cggA8A1D/rkIAAODgAADwNAAAxwAA//AwAABsAAAAMwAA//nAAAGwAAB/+8AAAFKAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzLocggA8A1D/rkIAAODgAADwNAAAGwAAAD8AAAD/8DAAAGwAAAAkAAAGLAAD/8AAAAYoAAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYQzLAsggA8A1D/rkIAAODgAADwNAAAcQAA//AwAABsAAAALgAA//nAAAGwAAB/+8AAAFrAAAP/wQAAAYoAD/8EAAAGFAA/+RAAABgQAD/8EAAAF0AD/8EAAAbQAD/8EAAAaQAD/8EAAAGaAA/+hAAAA//tQwMSYAzLAssgAPANQ/65CAADg4AAA8DQAAHYAAD/sDAAAGwAAAEsAAAP/5wAABsAAAf/vAAABiwAAD/8EAAAGKAA//BAAABhQAP/kQAAAYEAA//BAAABdAA//BAAAG0AA//BAAAGkAA//BAAABmgAP/oQAAAA//tQwMSYAzLAssgAPANQ/65CAADg4AAA8DQAAHYAAD/sDAAAGwAAAEsAAAP/5wAABsAAAf/vAAABiwAAD/8EAAAGKAA//BAAABhQAP/kQAAAYEAA//BAAABdAA//BAAAG0AA//BAAAGkAA//BAAABmgAP/oQAAAA//tQwMSYgzLAssgAPANQ/65CAADg4AAA8DQAAHYAAD/sDAAAGwAAAEsAAAP/5wAABsAAAf/vAAABiwAAD/8EAAAGKAA//BAAABhQAP/kQAAAYEAA//BAAABdAA//BAAAB0AA//BAAAGkAA//BAAABmgAP/oQAAAAAAAAAAAAAA');
    sound.play().catch(e => console.error("Could not play notification sound:", e));
  }

  isPastDue(reminder: Reminder): boolean {
    return new Date(reminder.due).getTime() < Date.now();
  }

  private saveReminders() {
    this.dataService.saveReminders(this.reminders()).subscribe({
      next: () => console.log('Reminders data saved.'),
      error: (err) => console.error('Failed to save reminders data:', err)
    });
  }
}
